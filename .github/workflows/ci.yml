name: Selenium BDD Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        browser: [chrome]
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Create reports directory
      run: mkdir -p reports/screenshots
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install Chrome
      if: matrix.browser == 'chrome'
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        google-chrome --version
    
    - name: Install Firefox
      if: matrix.browser == 'firefox'
      run: |
        sudo apt-get update
        sudo apt-get install -y firefox
        firefox --version
    
    - name: Setup virtual display
      run: |
        sudo apt-get install -y xvfb
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
    
    - name: Setup WebDriver cache and permissions
      run: |
        mkdir -p ~/.wdm
        chmod 755 ~/.wdm
        
        python3 << 'EOF'
        from webdriver_manager.chrome import ChromeDriverManager
        import os
        import stat
        import glob
        
        # Download ChromeDriver
        driver_path = ChromeDriverManager().install()
        print(f'ChromeDriver downloaded to: {driver_path}')
        
        # Check if the path exists and what type it is
        if os.path.exists(driver_path):
            if os.path.isfile(driver_path):
                print(f'Driver path is a file: {driver_path}')
                current_mode = os.stat(driver_path).st_mode
                os.chmod(driver_path, current_mode | stat.S_IXUSR | stat.S_IXGRP | stat.S_IXOTH)
                new_mode = oct(os.stat(driver_path).st_mode)[-3:]
                print(f'Set permissions to: {new_mode}')
            elif os.path.isdir(driver_path):
                print(f'Driver path is a directory: {driver_path}')
                for root, dirs, files in os.walk(driver_path):
                    for file in files:
                        if file == 'chromedriver' or file.startswith('chromedriver'):
                            actual_driver = os.path.join(root, file)
                            print(f'Found chromedriver at: {actual_driver}')
                            current_mode = os.stat(actual_driver).st_mode
                            os.chmod(actual_driver, current_mode | stat.S_IXUSR | stat.S_IXGRP | stat.S_IXOTH)
                            new_mode = oct(os.stat(actual_driver).st_mode)[-3:]
                            print(f'Set permissions to: {new_mode}')
                            break
        else:
            print(f'Driver path does not exist: {driver_path}')
        
        # List the WDM directory structure
        wdm_files = glob.glob(os.path.expanduser('~/.wdm/**/*'), recursive=True)
        print('WDM directory structure:')
        for f in wdm_files:
            if os.path.isfile(f):
                perms = oct(os.stat(f).st_mode)[-3:]
                print(f'  FILE: {f} (permissions: {perms})')
            else:
                print(f'  DIR:  {f}')
        EOF
    
    - name: Run tests
      env:
        BROWSER: ${{ matrix.browser }}
        HEADLESS: true
        TEST_EMAIL: ${{ secrets.TEST_EMAIL }}
        TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
        WDM_LOG_LEVEL: 0
        WDM_PRINT_FIRST_LINE: false
        DISPLAY: :99
      run: |
        # Debug environment
        echo "Current user: $(whoami)"
        echo "Chrome version: $(google-chrome --version)"
        echo "Python path: $(which python)"
        echo "WebDriver cache directory: ~/.wdm"
        ls -la ~/.wdm/ || echo "No cache directory found"
        
        # Run tests with verbose output
        pytest tests/ -v -s --html=reports/report-${{ matrix.browser }}.html --self-contained-html
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.browser }}
        path: reports/
    
    - name: Upload screenshots on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: screenshots-${{ matrix.browser }}
        path: reports/screenshots/